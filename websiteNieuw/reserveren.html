<!DOCTYPE html>
<html lang="nl">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Casa Mariposa</title>

    <!-- JOUW STYLES -->
    <link rel="stylesheet" href="styles/style.css" />
    <link href="https://fonts.googleapis.com/css2?family=Open+Sans:wght@400;600&display=swap" rel="stylesheet">

    <!-- Flatpickr (mooie datepicker) -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/themes/material_blue.css">
    <script defer src="https://cdn.jsdelivr.net/npm/flatpickr"></script>

    <!-- FullCalendar (grote kalender bovenaan) -->
    <link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.15/index.global.min.css" rel="stylesheet">
    <script defer src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.15/index.global.min.js"></script>

    <!-- Donkergrijs voor dagen vÃ³Ã³r vandaag -->
    <style>
        /* FullCalendar: verleden donkergrijs */
        .past-disabled {
            background: #eceff3 !important;
            color: #6b7280 !important;
        }
        /* Flatpickr: verleden donkergrijs */
        .fp-past {
            background: #eceff3 !important;
            color: #6b7280 !important;
        }
        .fp-past:hover { cursor: not-allowed; }
    </style>
</head>
<body>

<!-- Topbar -->
<div class="topbar">
    <p>ðŸ“§ info@casamariposa.com</p>
</div>

<!-- Header -->
<header class="main-header">
    <div class="logo-container">
        <img src="images/generated_image.png" alt="Logo Casa Mariposa" class="logo" />
        <h1>Casa Mariposa</h1>
    </div>
    <nav>
        <ul class="nav-menu">
            <li><a href="index.html">Home</a></li>
            <li><a href="omgeving.html">Omgeving</a></li>
            <li><a href="reserveren.html" class="active">Reserveren</a></li>
            <li class="dropdown">
                <a href="#">To doâ€™s </a>
                <ul class="dropdown-menu">
                    <li><a href="todos-beachlife.html">Beachlife</a></li>
                    <li><a href="todos-cultuur.html">Cultuur</a></li>
                </ul>
            </li>
            <li><a href="reisinformatie.html">Reisinformatie</a></li>
        </ul>
    </nav>
</header>

<!-- Grote kalender -->
<section id="availability" class="availability">
    <h2 style="font-size:2.3rem; margin: 10px 0 18px; color:#015482; text-align:center;">Beschikbaarheid</h2>
    <div id="bigCalendar" style="max-width:1100px;margin:0 auto; background:#fff; border-radius:14px; box-shadow:0 6px 24px rgba(1,84,130,.08); padding:16px;"></div>
    <p style="text-align:center; color:#667; margin-top:10px; font-size:.95rem;">Rood = bezet â€¢ Overige dagen = vrij</p>
</section>

<!-- Formulier -->
<section class="info-aanvraag-form">
    <h2 style="font-size:2.3rem; margin-bottom: 8px; color: #015482; text-align:center;">Info aanvraag</h2>
    <p style="max-width:600px; margin: 0 auto 32px auto; color:#444; text-align:center;">
        Vul het formulier in. Wij contacteren je zo snel mogelijk om de reservatie te bevestigen.
    </p>

    <form id="infoForm" style="max-width:680px; margin:0 auto; background:#fff; border-radius:14px; box-shadow:0 2px 16px rgba(1,84,130,0.07); padding:34px 8vw 22px 8vw;">
        <div style="display:flex; gap:18px; flex-wrap:wrap;">
            <div style="flex:1 1 200px; min-width:180px;">
                <label for="naam">Naam <span style="color:#e63946">*</span></label>
                <input type="text" id="naam" name="naam" required>
            </div>
            <div style="flex:1 1 200px; min-width:180px;">
                <label for="telefoon">Telefoonnummer <span style="color:#e63946">*</span></label>
                <input type="tel" id="telefoon" name="telefoon" required>
            </div>
        </div>

        <div style="display:flex; gap:18px; flex-wrap:wrap; margin-top:18px;">
            <div style="flex:1 1 200px; min-width:180px;">
                <label for="email">E-mail <span style="color:#e63946">*</span></label>
                <input type="email" id="email" name="email" required>
            </div>
            <div style="flex:1 1 200px; min-width:180px;">
                <label for="personen">Aantal personen <span style="color:#e63946">*</span></label>
                <input type="number" id="personen" name="personen" min="1" required>
            </div>
        </div>

        <div style="display:flex; gap:18px; flex-wrap:wrap; margin-top:18px;">
            <div style="flex:1 1 200px; min-width:180px;">
                <label for="aankomst">Gewenste datum van aankomst <span style="color:#e63946">*</span></label>
                <input type="text" id="aankomst" name="aankomst" placeholder="Kies aankomstdatum" required>
            </div>
            <div style="flex:1 1 200px; min-width:180px;">
                <label for="vertrek">Gewenste datum van vertrek <span style="color:#e63946">*</span></label>
                <input type="text" id="vertrek" name="vertrek" placeholder="Kies vertrekdatum" required>
            </div>
        </div>

        <div style="margin-top:18px;">
            <label for="bericht">Bericht <span style="color:#e63946">*</span></label>
            <textarea id="bericht" name="bericht" rows="4" style="width:100%;" required></textarea>
        </div>

        <div style="text-align:center; margin-top:24px;">
            <button type="submit" class="btn">Aanvraag indienen</button>
        </div>
    </form>
</section>

<section class="contact">
    <div class="contact-container">
        <div class="contact-info">
            <h3>Interesse? Neem contact op.</h3>
            <p>Stuur een bericht of contacteer ons telefonisch voor meer informatie.</p>
            <p><strong>+32 478 88 76 99</strong><br>info@casamariposa.be</p>
            <div class="socials">
                <a href="#"><img src="images/icons/facebook.svg" alt="Facebook"></a>
                <a href="#"><img src="images/icons/instagram.svg" alt="Instagram"></a>
                <a href="#"><img src="images/icons/whatsapp.svg" alt="WhatsApp"></a>
            </div>
            <a href="reserveren.html" class="btn">Reserveren</a>
        </div>
        <div class="contact-image">
            <img src="images/fam.jpg" alt="Foto van het gezin">
        </div>
    </div>
</section>
<hr class="divider">
<p class="disclaimer">Huisdieren zijn niet toegelaten in het domein en het is ook verboden om te roken in het hele appartement. Op het terras mag er wel gerookt worden.</p>

<!-- Ã‰Ã‰N scriptblok dat alles regelt -->
<script>
    // ===== CONFIG =====
    const WORKER_BASE = "https://casamariposa.driestaeleman47.workers.dev";
    const CAL_RANGE_MONTHS = 12;

    // ===== HELPERS =====
    const toISO = d => new Date(d.getTime() - d.getTimezoneOffset()*60000).toISOString().slice(0,10);
    const qs = sel => document.querySelector(sel);

    const todayLocal = new Date();
    todayLocal.setHours(0,0,0,0);
    const TODAY_STR = toISO(todayLocal);

    // Start
    document.addEventListener('DOMContentLoaded', init);

    async function init() {
        const today = new Date();
        const to = new Date(today); to.setMonth(to.getMonth() + CAL_RANGE_MONTHS);

        const busyRanges = await getBusyRanges(toISO(today), toISO(to)); // [{start, end(excl)}]
        renderBigCalendar(busyRanges);

        const busyDates = expandToDates(busyRanges); // Set('YYYY-MM-DD')
        setupFlatpickrs(busyDates);
        setupSubmit();
    }

    async function getBusyRanges(from, to) {
        const url = `${WORKER_BASE}/busy?from=${from}&to=${to}`;
        const res = await fetch(url, { cache: "no-store" });
        const data = await res.json(); // { busy: [ {from, to} ] }
        const list = data.busy || [];
        // 'to' is inclusief â†’ voor FullCalendar end exclusief maken (+1 dag)
        return list.map(r => {
            const end = new Date(r.to); end.setDate(end.getDate() + 1);
            return { start: r.from, end: toISO(end) };
        });
    }

    function renderBigCalendar(busyRanges) {
        const calendarEl = document.getElementById('bigCalendar');

        const busyEvents = busyRanges.map(r => ({
            title: "Bezet",
            start: r.start,
            end:   r.end, // exclusief
            display: "background",
            color: "#e63946",
            textColor: "#e63946",
            extendedProps: { tooltip: "Deze datum is al bezet" }
        }));

        const calendar = new FullCalendar.Calendar(calendarEl, {
            initialView: 'dayGridMonth',
            height: 'auto',
            fixedWeekCount: false,
            showNonCurrentDates: false,
            headerToolbar: { left: 'prev,next today', center: 'title', right: '' },
            dayMaxEventRows: true,
            events: busyEvents,

            // âœ… voeg class toe met ingebouwde vlag
            dayCellClassNames(arg) {
                return arg.isPast ? ['past-disabled'] : [];
            },

            dayCellDidMount(arg) {
                const dateStr = toISO(arg.date);
                const isBusy = busyRanges.some(r => dateStr >= r.start && dateStr < r.end);

                // tooltip
                arg.el.style.position = 'relative';
                const tip = document.createElement('div');
                tip.textContent = arg.isPast
                    ? "Deze datum is onbeschikbaar"
                    : (isBusy ? "Deze datum is al bezet" : "Deze datum is nog vrij");
                tip.className = 'day-tooltip';
                tip.style.cssText = `
        position:absolute; left:50%; bottom:110%;
        transform:translateX(-50%); background:#111; color:#fff; font-size:12px;
        padding:6px 8px; border-radius:6px; white-space:nowrap; pointer-events:none;
        opacity:0; transition:opacity .15s; z-index:5;`;
                arg.el.appendChild(tip);
                arg.el.addEventListener('mouseenter', ()=> tip.style.opacity = '1');
                arg.el.addEventListener('mouseleave', ()=> tip.style.opacity = '0');

                // âœ… forceer background op alle relevante lagen (voor thema's die overschrijven)
                if (arg.isPast) {
                    arg.el.style.background = '#eceff3';
                    const frame = arg.el.querySelector('.fc-daygrid-day-frame');
                    if (frame) frame.style.background = '#eceff3';
                    const bg = arg.el.querySelector('.fc-daygrid-day-bg');
                    if (bg) bg.style.background = '#eceff3';
                    arg.el.style.cursor = 'not-allowed';
                    return;
                }

                // Klik op vrije dag â†’ vul aankomst
                if (!isBusy) {
                    arg.el.style.cursor = 'pointer';
                    arg.el.addEventListener('click', () => {
                        const aankomst = qs('#aankomst');
                        if (aankomst && window.flatpickr && aankomst._flatpickr) {
                            aankomst._flatpickr.setDate(dateStr, true);
                            aankomst.scrollIntoView({ behavior: 'smooth', block: 'center' });
                        } else if (aankomst) {
                            aankomst.value = dateStr;
                            aankomst.dispatchEvent(new Event('change'));
                        }
                    });
                }
            }
        });

        calendar.render();
    }

    function expandToDates(busyRanges) {
        const s = new Set();
        busyRanges.forEach(r => {
            const start = new Date(r.start);
            const end = new Date(r.end); // exclusief
            for (let d = new Date(start); d < end; d.setDate(d.getDate() + 1)) {
                s.add(toISO(d));
            }
        });
        return s;
    }

    function setupFlatpickrs(busyDates) {
        const isBusy = (date) => busyDates.has(toISO(date));
        const aankomstEl = qs('#aankomst');
        const vertrekEl  = qs('#vertrek');

        const fpA = flatpickr(aankomstEl, {
            dateFormat: "Y-m-d",
            minDate: "today",
            disable: [ (date) => isBusy(date) ],
            onDayCreate: (_dObj, _dStr, fp, dayElem) => {
                const ds = toISO(dayElem.dateObj);
                if (ds < TODAY_STR) {
                    dayElem.classList.add('fp-past');
                    dayElem.title = 'Deze datum is onbeschikbaar';
                } else if (busyDates.has(ds)) {
                    dayElem.classList.add('fp-busy');
                    dayElem.title = 'Deze datum is al bezet';
                } else {
                    dayElem.title = 'Deze datum is nog vrij';
                }
            },
            onChange: (selectedDates) => {
                const start = selectedDates[0];
                if (!start) return;
                const minV = new Date(start); minV.setDate(minV.getDate() + 1);
                let cand = new Date(minV);
                while (isBusy(cand)) cand.setDate(cand.getDate() + 1);
                fpV.set('minDate', toISO(minV));
                if (!fpV.selectedDates?.length || fpV.selectedDates[0] <= start) {
                    fpV.setDate(toISO(cand), true);
                }
            }
        });

        const fpV = flatpickr(vertrekEl, {
            dateFormat: "Y-m-d",
            minDate: "today",
            disable: [
                (date) => {
                    const aDate = fpA.selectedDates?.[0];
                    if (aDate && date <= aDate) return true;
                    return isBusy(date);
                }
            ],
            onOpen: () => {
                const aDate = fpA.selectedDates?.[0];
                if (aDate) {
                    const minV = new Date(aDate); minV.setDate(minV.getDate() + 1);
                    fpV.set('minDate', toISO(minV));
                }
            },
            onDayCreate: (_dObj, _dStr, fp, dayElem) => {
                const ds = toISO(dayElem.dateObj);
                const aDate = fpA.selectedDates?.[0];
                if (ds < TODAY_STR || (aDate && dayElem.dateObj <= aDate) || busyDates.has(ds)) {
                    dayElem.classList.add('fp-past');
                    dayElem.title = 'Niet beschikbaar';
                } else {
                    dayElem.title = 'Beschikbaar';
                }
            }
        });
    }

    function setupSubmit() {
        const form = document.getElementById('infoForm');

        form.addEventListener('submit', async (e) => {
            e.preventDefault();

            const start = form.aankomst.value;
            const end   = form.vertrek.value;
            if (!start || !end || end <= start) {
                alert("Controleer de datums (vertrek moet na aankomst liggen).");
                return;
            }

            const payload = {
                naam: form.naam.value.trim(),
                email: form.email.value.trim(),
                telefoon: form.telefoon.value.trim(),
                personen: form.personen.value,
                bericht: form.bericht.value.trim(),
                start,
                end
            };
            const subject = encodeURIComponent(`Nieuwe reserveringsaanvraag van ${payload.naam}`);
            const body = encodeURIComponent(
                `Naam: ${payload.naam}
Telefoon: ${payload.telefoon}
E-mail: ${payload.email}
Aantal personen: ${payload.personen}
Aankomst: ${payload.start}
Vertrek: ${payload.end}

Bericht:
${payload.bericht}`
            );
            window.location.href = `mailto:evalaus@hotmail.com?subject=${subject}&body=${body}`;

            try {
                const res = await fetch(`${WORKER_BASE}/request`, {
                    method: 'POST',
                    headers: { 'Content-Type':'application/json' },
                    body: JSON.stringify(payload)
                });
                if (!res.ok) throw new Error(await res.text());
                alert("Aanvraag verstuurd! Je ontvangt snel een bevestiging.");
                form.reset();
            } catch (err) {
                console.error(err);
                alert("Kon de aanvraag niet opslaan. Probeer later opnieuw.");
            }
        });
    }

</script>
</body>
</html>
