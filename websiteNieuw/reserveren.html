<!DOCTYPE html>
<html lang="nl">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Casa Mariposa</title>

    <!-- JOUW STYLES -->
    <link rel="stylesheet" href="styles/style.css" />
    <link href="https://fonts.googleapis.com/css2?family=Open+Sans:wght@400;600&display=swap" rel="stylesheet">
    <link rel="icon" type="image/x-icon" href="/favicon.ico">

    <!-- Flatpickr (mooie datepicker) -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/themes/material_blue.css">
    <script defer src="https://cdn.jsdelivr.net/npm/flatpickr"></script>

    <!-- FullCalendar (grote kalender bovenaan) -->
    <link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.15/index.global.min.css" rel="stylesheet">
    <script defer src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.15/index.global.min.js"></script>

    <!-- Donkergrijs voor dagen vóór vandaag -->
    <style>
        /* FullCalendar: verleden donkergrijs */
        .past-disabled {
            background: #eceff3 !important;
            color: #6b7280 !important;
        }
        /* Flatpickr: verleden donkergrijs */
        .fp-past {
            background: #eceff3 !important;
            color: #6b7280 !important;
        }
        .fp-past:hover { cursor: not-allowed; }
    </style>
</head>
<body>

<!-- Topbar
<div class="topbar">
    <p>📧 info@casamariposa.be</p>
</div>
-->
<!-- Header -->
<header class="main-header">
    <div class="logo-container big-logo">
        <img src="images/generated_image.png" alt="Logo Casa Mariposa" class="logo" />
        <h1>Casa Mariposa</h1>
    </div>
    <nav>
        <ul class="nav-menu">
            <li><a href="index.html">Home</a></li>
            <li><a href="omgeving.html">Omgeving</a></li>
            <li><a href="sport.html">Sport</a></li>
            <li><a href="reserveren.html" class="active">Reserveren</a></li>
             <li><a href="reisinformatie.html">Reisinformatie</a></li>
         </ul>
     </nav>
 </header>

 <!-- Grote kalender -->
<section id="availability" class="availability">
    <h2 style="font-size:2.3rem; margin: 10px 0 18px; color:#015482; text-align:center;">Beschikbaarheid</h2>
    <div id="bigCalendar" style="max-width:1100px;margin:0 auto; background:#fff; border-radius:14px; box-shadow:0 6px 24px rgba(1,84,130,.08); padding:16px;"></div>
    <p style="text-align:center; color:#667; margin-top:10px; font-size:.95rem;">Rood = bezet • Overige dagen = vrij</p>
</section><section class="intro-text">
    <h2>Onze prijzen per week</h2>
    <p>Januari € 500</p>
    <p>Februari € 500</p>
    <p>Maart € € 500</p>
    <p>April € 650</p>
    <p>Mei € 650</p>
    <p>Juni € 950</p>
    <p>Juli € 1100</p>
    <p>Augustus € 1100</p>
    <p>September € 950</p>
    <p>Oktober € 650</p>
    <p>November € 500</p>
    <p>December € 500</p>
    <p>Schoolvakanties € 650,00 behalve Juli en Augustus</p>
    <p><strong>Waarborg: € 300</strong></p>
    <p><strong>Verplichte eindpoets en linnenservice: € 125</strong></p>
</section>
<!-- Formulier -->
<section class="info-aanvraag-form">
    <h2 style="font-size:2.3rem; margin-bottom: 8px; color: #015482; text-align:center;">Info aanvraag</h2>
    <p style="max-width:600px; margin: 0 auto 32px auto; color:#444; text-align:center;">
        Vul het formulier in. Wij contacteren je zo snel mogelijk om de reservatie te bevestigen.
    </p>

    <form id="infoForm" style="max-width:680px; margin:0 auto; background:#fff; border-radius:14px; box-shadow:0 2px 16px rgba(1,84,130,0.07); padding:34px 8vw 22px 8vw;">
        <div style="display:flex; gap:18px; flex-wrap:wrap;">
            <div style="flex:1 1 200px; min-width:180px;">
                <label for="naam">Naam <span style="color:#e63946">*</span></label>
                <input type="text" id="naam" name="naam" required>
            </div>
            <div style="flex:1 1 200px; min-width:180px;">
                <label for="telefoon">Telefoonnummer <span style="color:#e63946">*</span></label>
                <input type="tel" id="telefoon" name="telefoon" required>
            </div>
        </div>

        <div style="display:flex; gap:18px; flex-wrap:wrap; margin-top:18px;">
            <div style="flex:1 1 200px; min-width:180px;">
                <label for="email">E-mail <span style="color:#e63946">*</span></label>
                <input type="email" id="email" name="email" required>
            </div>
            <div style="flex:1 1 200px; min-width:180px;">
                <label for="personen">Aantal personen <span style="color:#e63946">*</span></label>
                <input type="number" id="personen" name="personen" min="1" required>
            </div>
        </div>

        <div style="display:flex; gap:18px; flex-wrap:wrap; margin-top:18px;">
            <div style="flex:1 1 200px; min-width:180px;">
                <label for="aankomst">Gewenste datum van aankomst <span style="color:#e63946">*</span></label>
                <input type="text" id="aankomst" name="aankomst" placeholder="Kies aankomstdatum" required>
            </div>
            <div style="flex:1 1 200px; min-width:180px;">
                <label for="vertrek">Gewenste datum van vertrek <span style="color:#e63946">*</span></label>
                <input type="text" id="vertrek" name="vertrek" placeholder="Kies vertrekdatum" required>
            </div>
        </div>

        <div style="margin-top:18px;">
            <label for="bericht">Bericht <span style="color:#e63946"></span></label>
            <textarea id="bericht" name="bericht" rows="4" style="width:100%;"></textarea>
        </div>

        <div style="text-align:center; margin-top:24px;">
            <button type="submit" class="btn">Aanvraag indienen</button>
        </div>
    </form>
</section>

<section class="contact">
    <div class="contact-container">
        <div class="contact-info">
            <h3>Interesse? Neem contact op.</h3>
            <p>Contacteer ons via het invulformulier of per mail / of via sociale media.</p>
            <p>
                <strong>info@casamariposa.be</strong>
            </p>
            <div class="socials">
                <a href="https://www.facebook.com/profile.php?id=61579181528028"><img src="images/Facebook_Logo_2023.png" alt="Facebook" id="facebook"></a>
                <a href="https://www.instagram.com/casamariposa.be?igsh=cGpudDJ5M2syZjFp"><img src="images/Instagram_icon.png" alt="Instagram" id="instagram"></a>
                <a href="https://Wa.me/+32493316554"><img src="images/whatsapp.png" alt="WhatsApp" id="whatsapp"></a>
            </div>
            <a href="reserveren.html" class="btn">Reserveren</a>
        </div>
        <div class="contact-image">
            <img src="images/fotoSangria.jpeg" alt="Foto van het gezin">
        </div>
    </div>
</section>
<hr class="divider">
<p class="disclaimer">&copy; Website gemaakt door Dries Taeleman — Contact: +32 468 04 79 21 | driestaeleman47@gmail.com</p>
<script>
    /* =========================
       CONFIG
       ========================= */
    const WORKER_BASE = "https://casamariposa.driestaeleman47.workers.dev"; // ← jouw Cloudflare Worker base
    const GAS_URL     = "https://script.google.com/macros/s/AKfycbxpZmjbqb-wZ146aaFRWFXDhPNwcKGZCcqIngJ9CaT50NDBY5f08HICz6YB_YcoKRG7/exec";              // ← jouw Google Apps Script Web App URL (eindigt op /exec)
    const CAL_RANGE_MONTHS = 12;
    const EXTRA_BUSY_DATES = [
        "2025-9-9",
        "2025-9-10",
        "2025-9-11",
        "2025-9-12",
        "2025-9-13",
        "2025-9-14",
        "2025-9-15",
        "2025-9-16",
        "2025-9-17",
        "2025-9-18",
        "2025-9-19",
        "2025-9-20",
        "2025-9-21",
        "2025-9-22",
        "2025-9-23",
        "2025-9-24",
        "2025-9-25",
        "2025-9-26",
        "2025-9-27",
        "2025-9-28",
        "2025-9-29",
        "2025-9-30",
        "2025-10-1",
        "2025-10-2",
        "2025-10-3",
        "2025-10-4",
        "2025-10-5",
        "2025-10-6",
        "2025-10-7",
        "2025-10-8",
        "2025-10-9",
        "2025-10-10",
        "2025-10-11",
        "2025-10-12",
        "2025-10-26",
        "2025-10-27",
        "2025-10-28",
        "2025-10-29",
        "2025-10-30",
        "2025-10-31",
        "2025-12-23",
        "2025-12-24",
        "2025-12-25",
        "2025-12-26",
        "2025-12-27",
        "2025-12-28",
        "2025-12-29",
        "2025-12-30",
        "2026-5-9",
        "2026-5-10",
        "2026-5-11",
        "2026-5-12",
        "2026-5-13",
        "2026-5-14",
        "2026-5-15",
        "2026-5-16",
        "2026-8-15",
        "2026-8-16",
        "2026-8-17",
        "2026-8-18",
        "2026-8-19",
        "2026-8-20",
        "2026-8-21",
        "2026-8-22",
    ];
    /* =========================
       HELPERS
       ========================= */
    const qs = sel => document.querySelector(sel);
    const toISO = d => new Date(d.getTime() - d.getTimezoneOffset()*60000).toISOString().slice(0,10);

    const todayLocal = new Date(); todayLocal.setHours(0,0,0,0);
    const TODAY_STR = toISO(todayLocal);

    /* =========================
       MAIN
       ========================= */
    document.addEventListener('DOMContentLoaded', init);

    async function init() {
        try {
            // 1) Busy ranges laden voor de grote kalender en flatpickr
            const today = new Date();
            const to = new Date(today); to.setMonth(to.getMonth() + CAL_RANGE_MONTHS);
            const busyRanges = await getBusyRanges(toISO(today), toISO(to)); // [{start, end(excl)}]

            renderBigCalendar(busyRanges);
            const busyDates = expandToDates(busyRanges); // Set('YYYY-MM-DD')
            setupFlatpickrs(busyDates);

            // 2) Submit handler instellen (één keer)
            setupSubmit();
        } catch (err) {
            console.error("Init error:", err);
        }
    }

    /* =========================
       DATA LADEN
       ========================= */
    async function getBusyRanges(from, to) {
        const url = `${WORKER_BASE}/busy?from=${from}&to=${to}`;
        const res = await fetch(url, { cache: "no-store" });
        const data = await res.json(); // { busy: [ {from, to} ] }
        const list = data.busy || [];

        const ranges = list.map(r => {
            const end = new Date(r.to); end.setDate(end.getDate() + 1);
            return { start: r.from, end: toISO(end) };
        });

        // 👇 extra manueel opgegeven datums toevoegen
        EXTRA_BUSY_DATES.forEach(dateStr => {
            const d = new Date(dateStr);
            const end = new Date(d); end.setDate(end.getDate() + 1);
            ranges.push({ start: toISO(d), end: toISO(end) });
        });

        return ranges;
    }

    /* =========================
       UI: FULLCALENDAR
       ========================= */
    function renderBigCalendar(busyRanges) {
        const calendarEl = document.getElementById('bigCalendar');

        const busyEvents = busyRanges.map(r => ({
            title: "Bezet",
            start: r.start,
            end:   r.end, // exclusief
            display: "background",
            color: "#e63946",
            textColor: "#e63946",
        }));

        const calendar = new FullCalendar.Calendar(calendarEl, {
            initialView: 'dayGridMonth',
            height: 'auto',
            fixedWeekCount: false,
            showNonCurrentDates: false,
            headerToolbar: { left: 'prev,next today', center: 'title', right: '' },
            dayMaxEventRows: true,
            events: busyEvents,

            dayCellClassNames(arg) {
                return arg.isPast ? ['past-disabled'] : [];
            },

            dayCellDidMount(arg) {
                const dateStr = toISO(arg.date);
                const isBusy = busyRanges.some(r => dateStr >= r.start && dateStr < r.end);

                // simpele tooltip
                arg.el.style.position = 'relative';
                const tip = document.createElement('div');
                tip.textContent = arg.isPast
                    ? "Deze datum is onbeschikbaar"
                    : (isBusy ? "Deze datum is al bezet" : "Deze datum is nog vrij");
                tip.className = 'day-tooltip';
                tip.style.cssText = `
        position:absolute; left:50%; bottom:110%;
        transform:translateX(-50%); background:#111; color:#fff; font-size:12px;
        padding:6px 8px; border-radius:6px; white-space:nowrap; pointer-events:none;
        opacity:0; transition:opacity .15s; z-index:5;`;
                arg.el.appendChild(tip);
                arg.el.addEventListener('mouseenter', ()=> tip.style.opacity = '1');
                arg.el.addEventListener('mouseleave', ()=> tip.style.opacity = '0');

                // verleden visueel dicht
                if (arg.isPast) {
                    arg.el.style.background = '#eceff3';
                    const frame = arg.el.querySelector('.fc-daygrid-day-frame'); if (frame) frame.style.background = '#eceff3';
                    const bg    = arg.el.querySelector('.fc-daygrid-day-bg');    if (bg)    bg.style.background = '#eceff3';
                    arg.el.style.cursor = 'not-allowed';
                    return;
                }

                // Klik op vrije dag → vul aankomst
                if (!isBusy) {
                    arg.el.style.cursor = 'pointer';
                    arg.el.addEventListener('click', () => {
                        const aankomst = qs('#aankomst');
                        if (aankomst && window.flatpickr && aankomst._flatpickr) {
                            aankomst._flatpickr.setDate(dateStr, true);
                            aankomst.scrollIntoView({ behavior: 'smooth', block: 'center' });
                        } else if (aankomst) {
                            aankomst.value = dateStr;
                            aankomst.dispatchEvent(new Event('change'));
                        }
                    });
                }
            }
        });

        calendar.render();
    }

    /* =========================
       HULP: Ranges → losse datums
       ========================= */
    function expandToDates(busyRanges) {
        const s = new Set();
        busyRanges.forEach(r => {
            const start = new Date(r.start);
            const end   = new Date(r.end); // exclusief
            for (let d = new Date(start); d < end; d.setDate(d.getDate() + 1)) {
                s.add(toISO(d));
            }
        });
        return s;
    }

    /* =========================
       UI: FLATPICKR
       ========================= */
    function setupFlatpickrs(busyDates) {
        const isBusy = (date) => busyDates.has(toISO(date));
        const aankomstEl = qs('#aankomst');
        const vertrekEl  = qs('#vertrek');

        const fpA = flatpickr(aankomstEl, {
            dateFormat: "Y-m-d",
            minDate: "today",
            disable: [ (date) => isBusy(date) ],
            onDayCreate: (_dObj, _dStr, fp, dayElem) => {
                const ds = toISO(dayElem.dateObj);
                if (ds < TODAY_STR) {
                    dayElem.classList.add('fp-past');
                    dayElem.title = 'Deze datum is onbeschikbaar';
                } else if (busyDates.has(ds)) {
                    dayElem.classList.add('fp-busy');
                    dayElem.title = 'Deze datum is al bezet';
                } else {
                    dayElem.title = 'Deze datum is nog vrij';
                }
            },
            onChange: (selectedDates) => {
                const start = selectedDates[0];
                if (!start) return;
                const minV = new Date(start); minV.setDate(minV.getDate() + 1);
                let cand = new Date(minV);
                while (isBusy(cand)) cand.setDate(cand.getDate() + 1);
                fpV.set('minDate', toISO(minV));
                if (!fpV.selectedDates?.length || fpV.selectedDates[0] <= start) {
                    fpV.setDate(toISO(cand), true);
                }
            }
        });

        const fpV = flatpickr(vertrekEl, {
            dateFormat: "Y-m-d",
            minDate: "today",
            disable: [
                (date) => {
                    const aDate = fpA.selectedDates?.[0];
                    if (aDate && date <= aDate) return true;
                    return isBusy(date);
                }
            ],
            onOpen: () => {
                const aDate = fpA.selectedDates?.[0];
                if (aDate) {
                    const minV = new Date(aDate); minV.setDate(minV.getDate() + 1);
                    fpV.set('minDate', toISO(minV));
                }
            },
            onDayCreate: (_dObj, _dStr, fp, dayElem) => {
                const ds = toISO(dayElem.dateObj);
                const aDate = fpA.selectedDates?.[0];
                if (ds < TODAY_STR || (aDate && dayElem.dateObj <= aDate) || busyDates.has(ds)) {
                    dayElem.classList.add('fp-past');
                    dayElem.title = 'Niet beschikbaar';
                } else {
                    dayElem.title = 'Beschikbaar';
                }
            }
        });
    }

    /* =========================
       SUBMIT + LOGGING
       ========================= */
    function setupSubmit() {
        const form = document.getElementById('infoForm');
        if (!form) return;

        form.addEventListener('submit', async (e) => {
            e.preventDefault();

            const btn = form.querySelector('button[type="submit"]');
            if (btn) { btn.disabled = true; btn.textContent = "Versturen…"; }

            try {
                const start = form.aankomst.value;
                const end   = form.vertrek.value;
                if (!start || !end || end <= start) {
                    alert("Controleer de datums (vertrek moet na aankomst liggen).");
                    return;
                }

                const payload = {
                    naam: form.naam.value.trim(),
                    email: form.email.value.trim(),
                    telefoon: form.telefoon.value.trim(),
                    personen: form.personen.value,
                    aankomst: start,
                    vertrek: end,
                    bericht: form.bericht.value.trim()
                };

                // 1) LOG naar Cloudflare Worker
                const workerReq = fetch(`${WORKER_BASE}/request`, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify(payload),
                    cache: "no-store",
                });

                // 2) LOG naar Google Apps Script (fire-and-forget; no-cors)
                const gasReq = fetch(GAS_URL, {
                    method: "POST",
                    mode: "no-cors",  // voorkomt CORS errors; response is 'opaque'
                    headers: { "Content-Type": "text/plain;charset=utf-8" }, // simple request
                    body: JSON.stringify(payload),
                });

                // Wacht op beide zonder te falen op één van de twee
                await Promise.allSettled([workerReq, gasReq]);

                // 3) Feedback + reset
                alert("✅ Aanvraag verstuurd en gelogd!");
                form.reset();

                // 4) Daarna mailto (zodat logging niet wordt afgebroken door navigatie)
                const subject = encodeURIComponent(`Nieuwe reserveringsaanvraag van ${payload.naam}`);
                const body = encodeURIComponent(
                    `Naam: ${payload.naam}
Telefoon: ${payload.telefoon}
E-mail: ${payload.email}
Aantal personen: ${payload.personen}
Aankomst: ${payload.aankomst}
Vertrek: ${payload.vertrek}

Bericht:
${payload.bericht}`
                );
                window.location.href = `mailto:info@casamariposa.be?subject=${subject}&body=${body}`;

            } catch (err) {
                console.error(err);
                alert("⚠️ Er ging iets mis bij het versturen. Probeer later opnieuw.");
            } finally {
                if (btn) { btn.disabled = false; btn.textContent = "Aanvraag indienen"; }
            }
        });
    }
</script>
</body>
</html>
